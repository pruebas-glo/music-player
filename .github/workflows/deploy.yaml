name: CD

on:
  push:
    branches:
      - main
    paths:
      - '**'
      - '!README.md'

env:
  BACKEND_IMAGE_NAME: globant-backend
  FRONTEND_IMAGE_NAME: globant-frontend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      
      - name: Login to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Backend Docker image
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/${{ env.BACKEND_IMAGE_NAME }}:${{ github.sha }} -f ./backend/Dockerfile ./backend

      - name: Push Backend Docker image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.BACKEND_IMAGE_NAME }}:${{ github.sha }}

      - name: Build Frontend Docker image
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ github.sha }} -f ./frontend/Dockerfile ./frontend

      - name: Push Frontend Docker image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ github.sha }}

      - name: Update values.yaml and commit
        run: |
          sed -i 's|repository:.*|repository: '${{ secrets.DOCKER_USERNAME }}/${{ env.BACKEND_IMAGE_NAME }}'|' ./backend/values.yaml
          sed -i 's|tag:.*|tag: '${{ github.sha }}'|' ./helm/values.yaml
          sed -i 's|repository:.*|repository: '${{ secrets.DOCKER_USERNAME }}/${{ env.FRONTEND_IMAGE_NAME }}'|' ./frontend/values.yaml
          sed -i 's|tag:.*|tag: '${{ github.sha }}'|' ./helm/values.yaml
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add ./music-player/values.yaml
          git commit -m "Update Helm values.yaml with new image tags"
          git push

      - name: Set up kubectl
        run: |
          kubectl config set-cluster my-cluster --server=${{ secrets.KUBE_API_SERVER }} --certificate-authority-data=${{ secrets.KUBE_CA_DATA }}
          kubectl config set-credentials my-user --token=${{ secrets.KUBE_TOKEN }}
          kubectl config set-context my-context --cluster=my-cluster --user=my-user --namespace=default
          kubectl config use-context my-context

      - name: Set up Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      - name: Update Kubernetes deployment with Helm
        run: |
          helm upgrade --install my-app ./helm --namespace default